class Animation{constructor(a){var b=Math.sign;let c=!1;this.animation_running=function(){return c},this.remove_fruits=function(b){let d=[];return b.forEach(b=>{d.push(new Promise(d=>{function e(){return 0<b.scale.x?(b.scale.x-=a/800,void(b.scale.y-=a/800)):void(b.scale.x=0,b.scale.y=0,App.ticker.remove(e),d())}c=!0,App.ticker.add(e)}))}),Promise.all(d).then(()=>{c=!1})},this.bring_down=function(b,d){let e=[];return b.forEach((b,f)=>{e.push(new Promise(e=>{function g(){return b.y<d[f]?void(b.y+=a):void(b.y=d[f],App.ticker.remove(g),e())}c=!0,App.ticker.add(g)}))}),Promise.all(e).then(()=>{c=!1})},this.interchangeX=function(d,e){let f=[];f=d.x>e.x?[d,e]:[e,d];let g=[f[0].x,f[1].x];return new Promise(d=>{function e(){return f[0].x>g[1]?(f[0].x-=b(g[0]-g[1])*a,void(f[1].x+=b(g[0]-g[1])*a)):void(f[0].x=g[1],f[1].x=g[0],App.ticker.remove(e),d())}c=!0,App.ticker.add(e)}).then(()=>{c=!1})},this.interchangeY=function(d,e){let f=[];f=d.y>e.y?[d,e]:[e,d];let g=[f[0].y,f[1].y];return new Promise(d=>{function e(){return f[0].y>g[1]?(f[0].y-=b(g[0]-g[1])*a,void(f[1].y+=b(g[0]-g[1])*a)):void(f[0].y=g[1],f[1].y=g[0],App.ticker.remove(e),d())}c=!0,App.ticker.add(e)}).then(()=>{c=!1})}}}class FruitArray extends Array{constructor(a){function b(){let a=[];for(let b=0;b<nr_of_cells;b++)for(let d=0;d<nr_of_cells;d++)null!=fruits_array[b][d]&&(a=a.concat(c(b,d)));return animation.remove_fruits(a).then(()=>{a.forEach(a=>{a.remove()})})}function c(a,b){let c=[],d=[],e=0;for(let c=a+1;c<nr_of_cells&&null!=fruits_array[c][b]&&fruits_array[a][b].equals(fruits_array[c][b]);c++)d.push(fruits_array[c][b]),e++;1<e&&(c=c.concat(d)),d=[],e=0;for(let c=b+1;c<nr_of_cells&&null!=fruits_array[a][c]&&fruits_array[a][b].equals(fruits_array[a][c]);c++)d.push(fruits_array[a][c]),e++;return 1<e&&(c=c.concat(d)),0!=c.length&&c.push(fruits_array[a][b]),c}function d(){let a=[],b=[],c=[];for(let d=0;d<nr_of_cells;d++)for(let e=nr_of_cells-1;-1<e;e--)if(null==fruits_array[e][d]){let f=0;for(let g=e-1;-1<g;g--)null!=fruits_array[g][d]&&(a.push(fruits_array[g][d]),b.push((e-f)*(cell_size+line_width)+cell_size/2),c.push(e-f++));break}return animation.bring_down(a,b).then(()=>{a.forEach((a,b)=>{fruits_array[a.i][a.j]=null,a.i=c[b],fruits_array[a.i][a.j]=a})})}function e(){let a=[],b=[];for(let c=0;c<nr_of_cells;c++)for(let d=0;d<nr_of_cells;d++)null==fruits_array[c][d]&&(fruits_array[c][d]=new Fruit(c,d),a.push(fruits_array[c][d]),b.push(c*(cell_size+line_width)+cell_size/2));return animation.bring_down(a,b)}super();for(let b=0;b<a;b++)this[b]=[];this.check_for_matches=function(){for(let a=0;a<nr_of_cells;a++)for(let b=0;b<nr_of_cells;b++)if(0<c(a,b).length)return!0;return!1},this.remove_all_and_refill=async function(){for(;this.check_for_matches();)await b(),await d(),await e()}}interchange(a,b){let c=a.i,d=b.i,e=a.j,f=b.j,g=fruits_array[c][e];fruits_array[c][e]=fruits_array[d][f],fruits_array[d][f]=g,fruits_array[c][e].i=c,fruits_array[c][e].j=e,fruits_array[d][f].i=d,fruits_array[d][f].j=f}}class Fruit extends PIXI.Sprite{constructor(a,b){super(textures.random()),App.stage.addChild(this),this.anchor.set(.5),this.position.x=b*(cell_size+line_width)+cell_size/2,this.position.y=(a-nr_of_cells+1)*(cell_size-line_width)-cell_size/2,this.scale.set(.4,.4),this.interactive=!0,this.i=a,this.j=b,this.on("pointerdown",onDragStart).on("pointerup",onDragEnd).on("pointerupoutside",onDragEnd).on("pointermove",onDragMove)}equals(a){return!(this.texture.textureCacheIds[0]!=a.texture.textureCacheIds[0])}remove(){App.stage.removeChild(this),fruits_array[this.i][this.j]=null,document.getElementById("score").innerHTML=parseInt(document.getElementById("score").innerHTML)+10}}function onDragStart(a){animation.animation_running()||(mouse_data={start:{x:a.data.global.x,y:a.data.global.y},current:a.data.global},selected_fruit=this,status="selected")}function onDragMove(){var a=Math.abs;if(animation.animation_running())return;if("static"==status)return;let b=a(mouse_data.start.x-mouse_data.current.x),c=a(mouse_data.start.y-mouse_data.current.y);b>cell_size/2?deltaX_function():c>cell_size/2&&deltaY_function()}async function deltaX_function(){let a;status="static",a=mouse_data.start.x>mouse_data.current.x?fruits_array[selected_fruit.i][selected_fruit.j-1]:fruits_array[selected_fruit.i][selected_fruit.j+1],await animation.interchangeX(selected_fruit,a),fruits_array.interchange(selected_fruit,a),fruits_array.check_for_matches()?await fruits_array.remove_all_and_refill():(await animation.interchangeX(selected_fruit,a),fruits_array.interchange(selected_fruit,a)),status="static",mouse_data=null,selected_fruit=null}async function deltaY_function(){let a;status="static",a=mouse_data.start.y>mouse_data.current.y?fruits_array[selected_fruit.i-1][selected_fruit.j]:fruits_array[selected_fruit.i+1][selected_fruit.j],await animation.interchangeY(selected_fruit,a),fruits_array.interchange(selected_fruit,a),fruits_array.check_for_matches()?await fruits_array.remove_all_and_refill():(await animation.interchangeY(selected_fruit,a),fruits_array.interchange(selected_fruit,a)),status="static",mouse_data=null,selected_fruit=null}function onDragEnd(){animation.animation_running()||(status="static",mouse_data=null,selected_fruit=null)}let mouse_data,selected_fruit,textures,status="static";const nr_of_cells=8,cell_size=60,line_width=.06*60,width=480+line_width*7,height=width;let App=new PIXI.Application({width:width,height:height,antialias:!0});document.getElementById("game_area").appendChild(App.view);let animation=new Animation(8);PIXI.loader.add("atlas.json").load(onAssetsLoaded);let fruits_array=new FruitArray(8),line=new PIXI.Graphics;App.stage.addChild(line);for(let a=1;a<nr_of_cells;a++)line.lineStyle(line_width,16777215).moveTo(cell_size*a+line_width*(a-1)+line_width/2,0).lineTo(cell_size*a+line_width*(a-1)+line_width/2,height),line.lineStyle(line_width,16777215).moveTo(0,cell_size*a+line_width*(a-1)+line_width/2).lineTo(width,cell_size*a+line_width*(a-1)+line_width/2);line=null;function onAssetsLoaded(){textures=["apple","avocado","banana","cocos","grape"].map(a=>PIXI.Texture.fromFrame(a)),textures.__proto__.random=function(){return this[Math.floor(Math.random()*this.length)]};let a=[],b=[];for(let c=0;c<nr_of_cells;c++)for(let d=0;d<nr_of_cells;d++)fruits_array[c][d]=new Fruit(c,d),a.push(fruits_array[c][d]),b.push(c*(cell_size+line_width)+30);animation.bring_down(a,b).then(()=>{fruits_array.remove_all_and_refill()})}function shuffle(){if(!animation.animation_running()){let a=[],b=[];for(let c=0;c<nr_of_cells;c++)for(let d=0;d<nr_of_cells;d++)fruits_array[c][d].remove(),fruits_array[c][d]=new Fruit(c,d),a.push(fruits_array[c][d]),b.push(c*(cell_size+line_width)+30);document.getElementById("score").innerHTML=parseInt(document.getElementById("score").innerHTML)-400,animation.bring_down(a,b).then(()=>{fruits_array.remove_all_and_refill()})}}